name: Deploy to Contabo Server

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy to Contabo server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.CONTABO_HOST }}
        username: ${{ secrets.CONTABO_USERNAME }}
        key: ${{ secrets.CONTABO_SSH_KEY }}
        script: |
          cd /opt/malluclub-bot || { echo "‚ùå Bot directory not found"; exit 1; }
          
          echo "üîÑ Starting deployment process..."
          
          # Stop the bot gracefully
          echo "‚èπÔ∏è Stopping bot..."
          pm2 stop malluclub-bot || echo "‚ö†Ô∏è Bot was not running"
          
          # Backup current version
          echo "üíæ Creating backup..."
          cp -r . ../malluclub-bot-backup-$(date +%Y%m%d-%H%M%S) || true
          
          # Pull latest changes
          echo "üì• Pulling latest changes..."
          git stash || true
          git pull origin main
          
          # Install/update dependencies
          echo "üì¶ Installing dependencies..."
          npm install --production
          
          # Check for .env file
          if [ ! -f ".env" ]; then
            echo "‚ùå .env file not found! Please create it first."
            exit 1
          fi
          
          # Verify bot files
          echo "üîç Verifying bot files..."
          node -c index.js || { echo "‚ùå Bot file has syntax errors"; exit 1; }
          node -c deploy-commands-new.js || { echo "‚ùå Deploy script has syntax errors"; exit 1; }
          
          # Deploy commands
          echo "üöÄ Deploying commands..."
          node deploy-commands-new.js || { echo "‚ùå Command deployment failed"; exit 1; }
          
          # Start the bot
          echo "‚ñ∂Ô∏è Starting bot..."
          pm2 start ecosystem.config.js || pm2 start index.js --name malluclub-bot
          
          # Wait a moment for startup
          sleep 3
          
          # Check status
          echo "üìä Checking bot status..."
          pm2 status malluclub-bot
          pm2 logs malluclub-bot --lines 10
          
          echo "‚úÖ Deployment completed successfully!"
