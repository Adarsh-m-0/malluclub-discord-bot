name: Deploy to Contabo Server

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy to Contabo server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.CONTABO_HOST }}
        username: ${{ secrets.CONTABO_USERNAME }}
        key: ${{ secrets.CONTABO_SSH_KEY }}
        script: |
          cd /opt/malluclub-bot || { echo "âŒ Bot directory not found"; exit 1; }
          
          echo "ðŸ”„ Starting deployment process..."
          
          # Stop the bot gracefully
          echo "â¹ï¸ Stopping bot..."
          pm2 stop malluclub-bot || echo "âš ï¸ Bot was not running"
          
          # Backup current version
          echo "ðŸ’¾ Creating backup..."
          cp -r . ../malluclub-bot-backup-$(date +%Y%m%d-%H%M%S) || true
          
          # Pull latest changes
          echo "ðŸ“¥ Pulling latest changes..."
          git stash || true
          git pull origin main
          
          # Install/update dependencies
          echo "ðŸ“¦ Installing dependencies..."
          npm install --production
          
          # Update environment variables from secrets
          echo "ðŸ” Updating environment variables..."
          cat > .env << 'EOL'
          # MalluClub Discord Bot Environment Variables - Auto-generated from GitHub Secrets
          
          # Discord Bot Configuration
          DISCORD_TOKEN=${{ secrets.DISCORD_TOKEN }}
          CLIENT_ID=${{ secrets.CLIENT_ID }}
          GUILD_ID=${{ secrets.GUILD_ID }}
          
          # MongoDB Configuration
          MONGODB_URI=${{ secrets.MONGODB_URI }}
          
          # Channel Configuration
          WELCOME_CHANNEL_ID=${{ secrets.WELCOME_CHANNEL_ID }}
          LOG_CHANNEL_ID=${{ secrets.LOG_CHANNEL_ID }}
          AUTO_ROLE_ID=${{ secrets.AUTO_ROLE_ID }}
          
          # Optional Configuration
          OWNER_IDS=${{ secrets.OWNER_IDS }}
          VOICE_XP_RATE=${{ secrets.VOICE_XP_RATE }}
          
          # Environment
          NODE_ENV=production
          EOL
          
          # Verify bot files
          echo "ðŸ” Verifying bot files..."
          node -c index.js || { echo "âŒ Bot file has syntax errors"; exit 1; }
          node -c deploy-commands-new.js || { echo "âŒ Deploy script has syntax errors"; exit 1; }
          
          # Deploy commands
          echo "ðŸš€ Deploying commands..."
          node deploy-commands-new.js || { echo "âŒ Command deployment failed"; exit 1; }
          
          # Start the bot
          echo "â–¶ï¸ Starting bot..."
          pm2 start ecosystem.config.js || pm2 start index.js --name malluclub-bot
          
          # Wait a moment for startup
          sleep 5
          
          # Check status
          echo "ðŸ“Š Checking bot status..."
          pm2 status malluclub-bot
          pm2 logs malluclub-bot --lines 10
          
          # Send success notification if webhook is configured
          if [ ! -z "${{ secrets.DISCORD_WEBHOOK_URL }}" ]; then
            curl -H "Content-Type: application/json" \
                 -d '{"content":"âœ… **MalluClub Bot** deployed successfully to Contabo server!"}' \
                 "${{ secrets.DISCORD_WEBHOOK_URL }}" || true
          fi
          
          echo "âœ… Deployment completed successfully!"
